# NOTE!

You probably want to see <a href="push.html">the newer version instead.</a>

# Push Notifications

## Introduction


## Requirements

Implementations for push notifications in mobile XMPP client apps have existed prior to 2014, but these implementations have either:

* Treated the client app and XMPP server as one unified service, such that push notifications only worked using the "official" client.
* Proxied a user's session through the client app's backend services in order to monitor for and trigger push notifications.

The goal for this protocol is to make the general case possible, whereby a user may use their client app of choice with her own server of choice. Therefore, the following requirements are to be met by this XEP:

* XMPP servers MUST NOT be limited by the protocol to support push notifications for only a single client app or proprietary push service.
* Client apps MUST be able to receive push notifications from multiple third-party XMPP servers.
* The protocol SHOULD eliminate the need of client apps to proxy a user's XMPP session in order to create the same push notification experience.

## Terminology

* **Client App**
  The term "client app" can be rather ambiguous, particularly for client apps targeted for mobile, as a "client app" can actually be comprised of both a **Client Backend Service** and a **Client App Instance**.

* **Client App Instance**
  A client app instance is what is normally thought of when "client app" is referenced. It is the actual program installed or running locally on a user's device.

* **Client Backend Service**
  Some client apps may provide additional services to their instances via a common backend server. For mobile, such backend services can provide push notification support.

* **Proprietary Push Service**
  Devices and apps which use push notifications typically rely on a proprietary push service that is specific to the device's OS provider (although open alternatives do exist). A common condition for using these push services is the use of private key material in order to publish notifications on behalf of a particular client app.

* **Push Target JID**
  The JID for a client backend service responsible for receiving a user's push notifications in order to process and convert into a proprietary push notification.

* **Push Notification**
  An XMPP message sent via the user's XMPP server to a registered push target JID in order to be converted into a proprietary push notification targeted to the user's device.

* **Proprietary Push Notification**
   A message sent via a proprietary push service to a user's device for a particular client app.


## Client Instance and Backend Service Interactions

In general, it is not needed to formalize how a client app instance communicates with its own client backend service, as that is an internal implementation detail and can be done in many different ways. However, it has been deemed useful to create a basic framework for such communications via XMPP, as both an example and as a means of proof-of-ownership for associating a client instance with a backend service JID. Routing client-to-backend communication through the XMPP server also can help reduce the implementation effort as well as the number of open connections and transmitted packets.

### Registration

The initial step in enabling push notifications is for the client instance to register itself with the client backend service. To do so, it MAY send a `<register />` element to a configured JID for its backend service. At minimum, the client instance SHOULD include a "device-id" field which contains a unique value identifying the device to a push notification service. The registration MAY also include a "session-id" value, generated by the client instance for that XMPP session.

    <iq type="set" to="push.client.example">
      <register xmlns="urn:xmpp:push:0">
        <x xmlns="jabber:x:data" type="submit">
          <field var="device-id"><value>...</value></field>
          <field var="session-id"><value>...</value></field>
        </x>
      </register>
    </iq>
    <iq type="result" from="push.client.example">
      <register xmlns="urn:xmpp:push:0">
        <x xmlns="jabber:x:data" type="result">
          <field var="service"><value>push-023.client.example</value></field>
        </x>
      </register>
    </iq>

The backend service MAY then return a result form that contains a field named "service" which contains the JID where the user's server will send push notifications.

As it is possible for the device ID token to change, the registration step MAY be done for each XMPP session.

## Enabling Notifications

Once a client app instance has registered with its backend service, it can then enable push notifications on the user's server after establishing a session. To do so, it sends an `<enable />` elelement with the attribute "service" set to the JID of the backend service that will receive the push notifications. If the client provided a session ID value when registering with its backend, a "sid" attribute MAY be included, containing the session ID.

    <iq type="set">
      <enable xmlns="urn:xmpp:push:0" sid="" service="push-023.client.example" />
    </iq>
    <iq type="result" />

## Configuring Notifications

The client implementation SHOULD be able to define the type and amount of data that is sent to the client backend service by the XMPP server. A privacy-aware client CAN expose this configuration to users, or provide default values that best suit a specific client backend service implementation. The configuration is performed using [XEP-0004: Data Forms](http://xmpp.org/extensions/xep-0004.html).

### Editing the Default Configuration for All Services
    <iq type="get">
      <configure xmlns="urn:xmpp:push:0" />
    </iq>
    <iq type="result">
      <configure xmlns="urn:xmpp:push:0">
        <x xmlns="jabber:x:data" type="form">
          <field type="hidden" var="FORM_TYPE">
            <value>urn:xmpp:push:0</value>
          </field>
          <field type="boolean" var="include-bodies">
            <value>1</value>
          </field>
          <field type="boolean" var="include-senders">
            <value>1</value>
          </field>
          <field type="boolean" var="message-count">
            <value>1</value>
          </field>
          <field type="boolean" var="pending-subscription-count">
            <value>1</value>
          </field>
          <field type="boolean" var="jingle-media">
            <value>1</value>
          </field>
          <field type="boolean" var="jingle-filetransfer">
            <value>1</value>
          </field>
          ...
        </x>
      </configure>
    </iq>

    <iq type="set">
      <configure xmlns="urn:xmpp:push:0">
        <x xmlns="urn:xmpp:push:0">
          ...
        </x>
      </configure>
    </iq>
    <iq type="result" />

### Editing the Configuration for a Particular Service

    <iq type="get">
      <configure xmlns="urn:xmpp:push:0" service="push-23.client.example"/>
    </iq>
    <iq type="result">
      <configure xmlns="urn:xmpp:push:0">
        <x xmlns="jabber:x:data" type="form">
          <field type="hidden" var="FORM_TYPE">
            <value>urn:xmpp:push:0</value>
          </field>
          <field type="boolean" var="include-bodies">
            <value>1</value>
          </field>
          <field type="boolean" var="include-senders">
            <value>1</value>
          </field>
          <field type="boolean" var="message-count">
            <value>1</value>
          </field>
          <field type="boolean" var="pending-subscription-count">
            <value>1</value>
          </field>
          <field type="boolean" var="jingle-media">
            <value>1</value>
          </field>
          <field type="boolean" var="jingle-filetransfer">
            <value>1</value>
          </field>
          ...
        </x>
      </configure>
    </iq>

When saving configuration changes for a specific push service, only the changed fields SHOULD be submitted, so that the server MAY appropriately propagate the settings from the default configuration for the the fields that were not set.

    <iq type="set">
      <configure xmlns="urn:xmpp:push:0" service="push-023.client.example">
        <x xmlns="urn:xmpp:push:0">
          ...
        </x>
      </configure>
    </iq>
    <iq type="result" />


## Disabling Notifications

If a user wishes to disable push notifications completely for a given client, a `<disable />` element MUST be sent, including a "service" attribute set to the target JID for the client backend service being removed.

    <iq type="set">
      <disable xmlns="urn:xmpp:push:0" service="push-023.client.example" />
    </iq>
    <iq type="result" />

If a backend service wishes to no longer receive push notifications for a particular user (i.e. after it was notified by the Proprietary Push Service that a client is no longer available), it should send a `<disable />` element to the user's bare JID. The server then MUST remove the JID specifed in the "from" attribute of the IQ request from the user's set of push notification services.

    <iq type="set" to="user@example.com" from="push-023.client.example">
      <disable xmlns="urn:xmpp:push:0" />
    </iq>
    <iq type="result" />

## Delivering a Push Notification

Once the user's server detects an event warranting a push notification, it then crafts a `<message />` stanza that includes  a `<push />` element, which contains an x-data form containing a summary of the data tracked for push notifications, such as offline message counts or number of new subscription requests.

The message's "from" attribute MUST be set to the user's bare JID.

    <message to="push-023.client.example" from="user@example.com">
      <push xmlns="urn:xmpp:push:0" sid="">
        <x xmlns="jabber:x:data">
          <field var="message-count"><value>1</value></field>
          <field var="message-sender"><value>juliet@capulet.example/balcony</value></field>
          <field var="message-body"><value>Wherefore art thou, Romeo?</value></field>
        </x>
      </push>
    </message>

### Where to Deliver Notifications

There are three cases which control where notifications are delivered:

1. A user has no active sessions.
2. A user is online, but has no active sessions using the client app.
3. A user has active sessions using the client app, but one or more of those sessions are using XEP-0198 stream management and have lost connection but the timeout period for the sessions have not expired.

In the first case, the notification SHOULD be delivered to all registered services. For the second case, the notification SHOULD be delivered to only those services which have no active user sessions.

For the third case, the notification will be delivered to the services associated with the sessions pending stream management timeout; however, if those sessions provided a "sid" value when enabling push notifications, then that value MUST be included in a "sid" attribute on the `<push />` element.

In any case, before delivering a notification, the server MUST verify that the target JID supports the service discovery feature "urn:xmpp:push:target" in order to mitigate potential spam issues.

## Security Considerations

Push notifications require routing private information, such as message bodies, through third parties. As such, server implementations SHOULD provide options for users to limit the information sent via push notifications.
